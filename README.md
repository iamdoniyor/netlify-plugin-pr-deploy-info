# Netlify Plugin: PR Deploy Info

A Netlify Build Plugin that automatically posts deploy preview information to GitHub pull request comments. Keep your team informed with deploy URLs, backend API endpoints, and commit information directly in your PRs.

## Features

- **Automatic PR Comments**: Posts deploy preview information to GitHub PRs automatically on successful builds
- **Smart Updates**: Updates existing comments instead of creating new ones (prevents comment spam)
- **Configurable**: Customize which environment variable to display via plugin inputs
- **Non-Blocking**: Errors won't fail your builds - the plugin logs errors and continues gracefully
- **Rich Information**: Displays deploy URL, backend API URL (or custom env var), and commit SHA

## Installation

Add the plugin to your `netlify.toml` file:

```toml
[[plugins]]
  package = "https://github.com/iamdoniyor/netlify-plugin-pr-deploy-info"

  # Optional: Configure which environment variable to display
  [plugins.inputs]
    envVarName = "VITE_GATEWAY_API_URL"  # Default: VITE_GATEWAY_API_URL
```

## Configuration

### Plugin Inputs

| Input | Description | Default | Required |
|-------|-------------|---------|----------|
| `envVarName` | Name of the environment variable to display as "Backend API" | `VITE_GATEWAY_API_URL` | No |

### Example Configuration

```toml
[[plugins]]
  package = "https://github.com/iamdoniyor/netlify-plugin-pr-deploy-info"

  [plugins.inputs]
    # Display your API endpoint
    envVarName = "VITE_API_URL"

    # Or any other environment variable
    # envVarName = "REACT_APP_API_URL"
    # envVarName = "NEXT_PUBLIC_API_URL"
```

## Setup Requirements

### GitHub Token

This plugin requires a `GITHUB_TOKEN` environment variable with permissions to comment on pull requests.

**Steps to set up:**

1. Create a GitHub Personal Access Token (classic):
   - Go to GitHub Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)
   - Click "Generate new token (classic)"
   - Give it a descriptive name (e.g., "Netlify PR Commenter")
   - Select scopes: `repo` (or `public_repo` for public repositories only)
   - Copy the generated token

2. Add the token to Netlify:
   - Go to your Netlify site â†’ Site settings â†’ Environment variables
   - Add a new variable:
     - **Key**: `GITHUB_TOKEN`
     - **Value**: Your GitHub token
     - **Scopes**: All (or specific deploy contexts as needed)

## Example PR Comment

When a deploy preview is ready, the plugin will post a comment like this:

```
ðŸš€ Deploy Preview Ready

Deploy URL: https://deploy-preview-123--your-site.netlify.app
Backend API: `https://api.staging.example.com`
Commit: `abc1234`

---
This comment was automatically generated by the backend-env-commenter plugin
```

If you push new commits to the PR, the existing comment will be updated with the new information instead of creating a new comment.

## How It Works

1. The plugin runs on the `onSuccess` event after a successful build
2. It checks if the build is for a deploy preview (PR context)
3. It retrieves deploy information from Netlify environment variables
4. It posts or updates a comment on the GitHub PR using the GitHub API
5. If any errors occur, they are logged but don't fail the build

## Troubleshooting

### Plugin not posting comments

**Check these common issues:**

1. **Missing GITHUB_TOKEN**
   - Error: `ERROR: GITHUB_TOKEN environment variable is not set`
   - Solution: Add the `GITHUB_TOKEN` environment variable in Netlify (see Setup Requirements)

2. **Insufficient GitHub token permissions**
   - Error: `ERROR: Failed to post comment to GitHub: ... 403 ...`
   - Solution: Ensure your GitHub token has `repo` scope for private repos or `public_repo` for public repos

3. **Not running on deploy previews**
   - The plugin only runs on deploy preview contexts (pull requests)
   - It will not run on production or branch deploys

4. **Missing REVIEW_ID**
   - Error: `ERROR: REVIEW_ID environment variable is not set`
   - Solution: This usually means Netlify isn't detecting the PR. Ensure your repository is properly connected and the build is triggered by a PR

### Custom environment variable not showing

- Ensure the environment variable specified in `envVarName` exists in your Netlify environment
- Check the build logs to see what value is being used
- If the variable doesn't exist, the plugin will display `unknown`

### Comments appear on wrong PR

- This shouldn't happen - the plugin uses Netlify's `REVIEW_ID` to identify the correct PR
- If this occurs, please open an issue with details about your setup

## Development

### Local Testing

```bash
# Install dependencies
npm install

# Lint code
npm run lint  # (if you have a lint script)
```

### Plugin Structure

- `index.js` - Main plugin code
- `manifest.yml` - Plugin manifest with metadata and inputs
- `package.json` - Package metadata and dependencies

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

MIT License - see [LICENSE](LICENSE) file for details

## Author

Doniyor

## Links

- [GitHub Repository](https://github.com/iamdoniyor/netlify-plugin-pr-deploy-info)
- [Issue Tracker](https://github.com/iamdoniyor/netlify-plugin-pr-deploy-info/issues)
- [Netlify Build Plugins Documentation](https://docs.netlify.com/configure-builds/build-plugins/)
